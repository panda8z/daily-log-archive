
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Goroutine是怎么开始和退出的 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../2020-03-18/gitbook工具使用指南.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    2020年Panda8z的面试笔记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../2020-03-18/面试准备Day01.html">
            
                <a href="../2020-03-18/面试准备Day01.html">
            
                    
                    面试准备Day01
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../2020-03-18/gitbook工具使用指南.html">
            
                <a href="../2020-03-18/gitbook工具使用指南.html">
            
                    
                    gitbook工具使用指南
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="Goroutine是怎么开始和退出的.html">
            
                <a href="Goroutine是怎么开始和退出的.html">
            
                    
                    Goroutine是怎么开始和退出的
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    2020-04-07
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../2020-04-07/defer的前世今生.html">
            
                <a href="../2020-04-07/defer的前世今生.html">
            
                    
                    defer的前世今生
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../2020-04-07/Go中defer.html">
            
                <a href="../2020-04-07/Go中defer.html">
            
                    
                    Go中defer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../2020-04-07/Go中defer7个知识点.html">
            
                <a href="../2020-04-07/Go中defer7个知识点.html">
            
                    
                    Go中defer7个知识点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../2020-04-07/Go实现LeetCode全集.html">
            
                <a href="../2020-04-07/Go实现LeetCode全集.html">
            
                    
                    Go实现LeetCode全集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../2020-04-07/如何成为Go语言代码贡献者.html">
            
                <a href="../2020-04-07/如何成为Go语言代码贡献者.html">
            
                    
                    如何成为Go语言代码贡献者
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="../2020-04-07/读书笔记-2020-04-07.html">
            
                <a href="../2020-04-07/读书笔记-2020-04-07.html">
            
                    
                    读书笔记-2020-04-07
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    2020-04-08
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../2020-04-08/go编译器-编译指示.html">
            
                <a href="../2020-04-08/go编译器-编译指示.html">
            
                    
                    编译指示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../2020-04-08/go做一个小型http服务器并优化实战.html">
            
                <a href="../2020-04-08/go做一个小型http服务器并优化实战.html">
            
                    
                    go做一个小型http服务器并优化实战
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" >
            
                <span>
            
                    
                    2020-04-09
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../2020-04-09/Go语言原本-调度器.html">
            
                <a href="../2020-04-09/Go语言原本-调度器.html">
            
                    
                    Go语言原本-调度器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" >
            
                <span>
            
                    
                    2020-04-10
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../2020-04-10/go垃圾回收.html">
            
                <a href="../2020-04-10/go垃圾回收.html">
            
                    
                    go垃圾回收
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" >
            
                <span>
            
                    
                    2020-04-11
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="../2020-04-11/2020-04-11-日志.html">
            
                <a href="../2020-04-11/2020-04-11-日志.html">
            
                    
                    2020-04-11-日志
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.10" >
            
                <span>
            
                    
                    2020-04-12
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="../2020-04-12/Go语言原本-延迟语句.html">
            
                <a href="../2020-04-12/Go语言原本-延迟语句.html">
            
                    
                    Go语言原本-延迟语句
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.12" >
            
                <span>
            
                    
                    2020-04-13
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="3.13" data-path="../2020-04-13/Go语言原本-channel.html">
            
                <a href="../2020-04-13/Go语言原本-channel.html">
            
                    
                    Go语言原本-channel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.14" data-path="../2020-04-13/2020-04-13-日志.html">
            
                <a href="../2020-04-13/2020-04-13-日志.html">
            
                    
                    2020-04-13-日志
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    2020-04-14
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../2020-04-14/G0是怎么创建的.html">
            
                <a href="../2020-04-14/G0是怎么创建的.html">
            
                    
                    G0是怎么创建的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../2020-04-14/从0构建亿级微服务架构.html">
            
                <a href="../2020-04-14/从0构建亿级微服务架构.html">
            
                    
                    从0构建亿级微服务架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" >
            
                <span>
            
                    
                    2020-04-15
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Goroutine是怎么开始和退出的</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="go-goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x7684;&#xFF1F;">Go: Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x7684;&#xFF1F;</h1>
<p>&#x539F;&#x6587;&#xFF1A;<a href="https://medium.com/a-journey-with-go/go-how-does-a-goroutine-start-and-exit-2b3303890452" target="_blank">Go: How Does a Goroutine Start and Exit? - A Journey With Go - Medium</a></p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*zPgr8y2GrQd_QIDw6DOY6g.png" alt="Illustration created for &#x201C;A Journey With Go&#x201D;, made from the original Go Gopher, created by Renee French."></p>
<p>&#x539F;&#x6587;&#x6253;&#x5370;&#x7684;PDF&#xFF1A;<a href="Go_%20How%20Does%20a%20Goroutine%20Start%20and%20Exit_%20-%20A%20Journey%20With%20Go%20-%20Medium.pdf">Go-How Does a Goroutine Start and Exit_ - A Journey With Go - Medium</a></p>
<p>&#x2139;&#xFE0F; <em>This article is based on Go 1.14.</em></p>
<p>In Go, a goroutine is nothing but a Go structure containing information regarding the running program, such as stack, program counter, or its current OS thread. The Go scheduler deals with that information to give them running time. The scheduler also has to pay attention at the start and the exit of the goroutines, two phases that need to be managed carefully.</p>
<p><em>For more information about the stack and the program counter, I suggest you read my article &#x201C;</em><a href="https://medium.com/a-journey-with-go/go-what-a-goroutine-switch-actually-involve-394c202dddb7" target="_blank"><em>Go: What a Goroutine Switch Actually Involve?</em></a><em>&#x201D;</em></p>
<h3 id="start">Start</h3>
<p>The <code>main</code> function starts a goroutine before printing a message. Since the goroutine will have its own running time, Go notifies the runtime to set up a new goroutine, meaning:</p>
<ul>
<li>Creating the stack.</li>
<li>Collecting information about the current program counter or caller&#x2019;s data.</li>
<li>Updating internal data of the goroutine such as ID or status.</li>
</ul>
<p>However, the goroutine does not get any runtime immediately. The newly created goroutine will be enqueued at the beginning of the local queue and will run at the next round of the Go scheduler. Here is a diagram of the current state:</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*qv1yYIHhZ-ukaxGKkahbxg.png" alt="img"></p>
<p>Putting the goroutine at the head of the queue makes it the first to run after the current goroutine. It will run either on the same thread or on another one if any work-stealing happens.</p>
<p><em>For more information about the work-stealing, I suggest you read my article &#x201C;</em><a href="https://medium.com/a-journey-with-go/go-work-stealing-in-go-scheduler-d439231be64d" target="_blank"><em>Go: Work-Stealing in Go Scheduler</em></a><em>.&#x201D;</em></p>
<p>The goroutine creation also can be seen in the assembly instructions:</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*2aRcWCHmXUX-Xyuddo8e_g.png" alt="img"></p>
<p>Once the goroutine is created and pushed onto the local queue of goroutines, it goes directly to the next instructions of the main function.</p>
<h1 id="exit">Exit</h1>
<p>When a goroutine ends, Go must schedule another goroutine to not waste the CPU time. It will also keep the goroutine to reuse it later.</p>
<p><em>You can find more information about the recycling of the goroutine in my article &#x201C;</em><a href="https://medium.com/a-journey-with-go/go-how-does-go-recycle-goroutines-f047a79ab352" target="_blank"><em>Go: How Does Go Recycle Goroutines?</em></a><em>&#x201D;</em></p>
<p>However, Go needs a way to be aware of the end of the goroutine. This control is during the creation of the goroutine. While creating the goroutine, Go sets the stack to a function named <code>goexit</code> before setting the program counter to the real function called by the goroutine. This trick forces the goroutine to call the function <code>goexit</code> after ending its work. The following program allows us to visualize it:</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*JHfai65TtDmjn1RIoCN7aw-20200405145110573.png" alt="img"></p>
<p>The output will complete the stack trace:</p>
<pre><code>/path/to/src/main.go:16
/usr/local/go/src/runtime/asm_amd64.s:1373
</code></pre><p>The file <code>asm_amd64</code> written in assembly contains this function:</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*sYPAxaZxZ6aqFKgw3BYPEg-20200405145110428.png" alt="img"></p>
<p>Then, Go will switch to <code>g0</code> to schedule another goroutine.</p>
<p>It is also possible to stop the goroutine manually by calling <code>runtime.Goexit()</code>:</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*4hxav30Z3T8uwoNyWlfiOQ-20200405145110460.png" alt="img"></p>
<p>This function will run the deferred functions first, then will call the same function seen previously when a goroutine exits.</p>
<hr>
<p>&#x2139;&#xFE0F; &#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4F9D;&#x636E; Go 1.14</p>
<p>&#x5728; Go &#x4E2D;&#xFF0C;goroutine &#x53EA;&#x662F; Go &#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x6709;&#x5173;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x7A0B;&#x5E8F;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4F8B;&#x5982;<strong>&#x5806;&#x6808;</strong>&#xFF0C;<strong>&#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;</strong>&#x6216;&#x5176;&#x5F53;&#x524D;&#x7684;<strong>OS&#x7EBF;&#x7A0B;</strong>&#x3002; Go<strong>&#x8C03;&#x5EA6;&#x7A0B;&#x5E8F;</strong>&#x4F1A;&#x5904;&#x7406;&#x8BE5;&#x4FE1;&#x606F;&#xFF0C;&#x4EE5;&#x63D0;&#x4F9B;&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x3002; <strong>&#x8C03;&#x5EA6;&#x7A0B;&#x5E8F;</strong>&#x8FD8;&#x5FC5;&#x987B;&#x6CE8;&#x610F; goroutine &#x7684;<em>&#x5F00;&#x59CB;</em>&#x548C;<em>&#x9000;&#x51FA;</em>&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x9636;&#x6BB5;&#x9700;&#x8981;&#x4ED4;&#x7EC6;&#x7BA1;&#x7406;&#x3002;
&#x53E6;&#x5916;&#xFF0C;&#x6709;&#x5173;&#x5806;&#x6808;&#x548C;&#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x5EFA;&#x8BAE;&#x60A8;&#x9605;&#x8BFB;&#x6211;&#x7684;&#x6587;&#x7AE0; &#x201C; Go&#xFF1A;Goroutine&#x5F00;&#x5173;&#x5B9E;&#x9645;&#x4E0A;&#x6D89;&#x53CA;&#x4EC0;&#x4E48;&#xFF1F;&#x201C;<em><a href="https://medium.com/a-journey-with-go/go-what-a-goroutine-switch-actually-involve-394c202dddb7" target="_blank">Go&#xFF1A;Goroutine&#x5F00;&#x5173;&#x5B9E;&#x9645;&#x4E0A;&#x6D89;&#x53CA;&#x4EC0;&#x4E48;&#xFF1F;</a></em>&#x201D;*</p>
<h3 id="&#x5F00;&#x59CB;">&#x5F00;&#x59CB;</h3>
<p>&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x8F7B;&#x677E;&#x5730;&#x5F00;&#x59CB;&#x4E00;&#x4E2A; gotoutine &#x3002;&#x770B;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#x3002;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*SV9rJSGF4njpahxXE1RICQ.png" alt="img"></p>
<p>main &#x51FD;&#x6570;&#x5728;&#x6253;&#x5370;&#x6D88;&#x606F;&#x4E4B;&#x524D;&#x542F;&#x52A8; goroutine &#x3002; &#x7531;&#x4E8E; goroutine &#x5177;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#xFF0C;&#x56E0;&#x6B64; Go &#x4F1A;&#x901A;&#x77E5;<strong>&#x8FD0;&#x884C;&#x65F6;</strong>&#x8BBE;&#x7F6E;&#x65B0;&#x7684; goroutine&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#xFF1A;</p>
<ul>
<li>&#x521B;&#x5EFA;&#x5806;&#x6808;&#x3002;</li>
<li>&#x6536;&#x96C6;&#x6709;&#x5173;&#x5F53;&#x524D;<strong>&#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;</strong>&#x6216;&#x8C03;&#x7528;&#x8005;&#x6570;&#x636E;&#x7684;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x66F4;&#x65B0;goroutine&#x7684;&#x5185;&#x90E8;&#x6570;&#x636E;&#xFF0C;&#x4F8B;&#x5982;ID&#x6216;&#x72B6;&#x6001;&#x3002;</li>
</ul>
<p>&#x4F46;&#x662F;&#xFF0C;goroutine &#x4E0D;&#x4F1A;&#x7ACB;&#x5373;&#x83B7;&#x5F97;&#x4EFB;&#x4F55;&#x8FD0;&#x884C;&#x65F6;&#x3002; &#x65B0;&#x521B;&#x5EFA;&#x7684; goroutine &#x5C06;&#x5728;&#x672C;&#x5730;&#x961F;&#x5217;&#x7684;&#x5F00;&#x59CB;&#x5904;&#x6392;&#x961F;&#xFF0C;&#x5E76;&#x5C06;&#x5728; Go <strong>&#x8C03;&#x5EA6;&#x7A0B;&#x5E8F;</strong>&#x7684;&#x4E0B;&#x4E00;&#x8F6E;&#x8FD0;&#x884C;&#x3002; &#x4E0B;&#x9762;&#x1F447;&#x662F;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x7684;&#x56FE;&#x8868;&#x1F4C8;&#xFF1A;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*qv1yYIHhZ-ukaxGKkahbxg.png" alt="img"></p>
<p>&#x5C06; goroutine &#x653E;&#x5728;&#x961F;&#x5217;&#x7684;&#x6700;&#x524D;&#x9762;&#xFF0C;&#x4F7F;&#x5176;&#x5728;&#x5F53;&#x524D; goroutine &#x4E4B;&#x540E;&#x7B2C;&#x4E00;&#x4E2A;&#x8FD0;&#x884C;&#x3002; &#x5982;&#x679C;&#x53D1;&#x751F;&#x4EFB;&#x4F55;<a href="https://blog.csdn.net/pange1991/article/details/80944797" target="_blank">&#x5DE5;&#x4F5C;&#x7A83;&#x53D6;</a>&#xFF0C;&#x5B83;&#x5C06;&#x5728;&#x540C;&#x4E00;&#x7EBF;&#x7A0B;&#x6216;&#x53E6;&#x4E00;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FD0;&#x884C;&#x3002;
<em>&#x6709;&#x5173;&#x5DE5;&#x4F5C;&#x7A83;&#x53D6;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x5EFA;&#x8BAE;&#x60A8;&#x9605;&#x8BFB;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x201C; <a href="https://medium.com/a-journey-with-go/go-work-stealing-in-go-scheduler-d439231be64d" target="_blank">Go&#xFF1A;Go Scheduler&#x4E2D;&#x7684;&#x5DE5;&#x4F5C;&#x7A83;&#x53D6;</a>&#x201D;&#x3002;</em></p>
<p>goroutine &#x7684;&#x521B;&#x5EFA;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x4E2D;&#x770B;&#x5230;&#xFF1A;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*2aRcWCHmXUX-Xyuddo8e_g.png" alt="img"></p>
<p>&#x4E00;&#x65E6;&#x521B;&#x5EFA;&#x4E86; goroutine&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x63A8;&#x5165; goroutine &#x7684;&#x672C;&#x5730;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x5B83;&#x5C06;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x4E3B;&#x51FD;&#x6570;&#x7684;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x3002;</p>
<h3 id="&#x9000;&#x51FA;">&#x9000;&#x51FA;</h3>
<p>&#x5F53; goroutine &#x7ED3;&#x675F;&#x65F6;&#xFF0C;Go&#x5FC5;&#x987B;&#x5B89;&#x6392;&#x5E76;&#x6267;&#x884C;&#x53E6;&#x4E00;&#x4E2A; goroutine&#xFF0C;&#x4EE5;&#x514D;&#x6D6A;&#x8D39;CPU&#x65F6;&#x95F4;&#x3002;&#x5B83;&#x8FD8;&#x5C06;&#x4FDD;&#x7559; goroutine &#x4EE5;&#x4FBF;&#x4EE5;&#x540E;&#x91CD;&#x7528;&#x3002;</p>
<p><em>&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x201C;<a href="https://medium.com/a-journey-with-go/go-how-does-go-recycle-goroutines-f047a79ab352" target="_blank"> Go&#xFF1A;Go&#x5982;&#x4F55;&#x56DE;&#x6536;Goroutines&#xFF1F;</a>&#x201D;&#x4E2D;&#x627E;&#x5230;&#x6709;&#x5173;goroutine&#x56DE;&#x6536;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#x3002;</em></p>
<p>&#x4F46;&#x662F;&#xFF0C;Go&#x9700;&#x8981;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x77E5;&#x9053; goroutine &#x7684;&#x7ED3;&#x675F;&#x3002;&#x6B64;&#x63A7;&#x5236;&#x662F;&#x5728; goroutine &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;&#x521B;&#x5EFA; goroutine &#x65F6;&#xFF0C;Go&#x4F1A;&#x5C06;&#x5806;&#x6808;&#x8BBE;&#x7F6E;&#x4E3A;&#x540D;&#x4E3A; <code>goexit</code> &#x7684;&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5C06;<strong>&#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;</strong>&#x8BBE;&#x7F6E;&#x4E3A; goroutine &#x8C03;&#x7528;&#x7684;&#x5B9E;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x6280;&#x5DE7;&#x8FEB;&#x4F7F; goroutine &#x5728;&#x7ED3;&#x675F;&#x5DE5;&#x4F5C;&#x540E;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>goexit</code>&#x3002;&#x4EE5;&#x4E0B;&#x7A0B;&#x5E8F;&#x4F7F;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x53EF;&#x89C6;&#x5316;&#xFF1A;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*JHfai65TtDmjn1RIoCN7aw-20200405145110573.png" alt="img"></p>
<p>&#x8F93;&#x51FA;&#x5C06;&#x5B8C;&#x6210;&#x5806;&#x6808;&#x8DDF;&#x8E2A;&#xFF1A;</p>
<pre><code class="lang-bash">/path/to/src/main.go:16
/usr/<span class="hljs-built_in">local</span>/go/src/runtime/asm_amd64.s:1373
</code></pre>
<p>&#x7528;&#x6C47;&#x7F16;&#x8BED;&#x8A00;&#x7F16;&#x5199;&#x7684;&#x6587;&#x4EF6; <code>asm_amd64</code> &#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x529F;&#x80FD;&#xFF1A;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*sYPAxaZxZ6aqFKgw3BYPEg-20200405145110428.png" alt="img"></p>
<p>&#x7136;&#x540E;&#xFF0C;Go &#x5C06;&#x5207;&#x6362;&#x5230; g0 &#x5B89;&#x6392;&#x53E6;&#x4E00;&#x4E2A; goroutine&#x3002;
&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x7528; <code>runtime.Goexit()</code> &#x6765;&#x624B;&#x52A8;&#x505C;&#x6B62; goroutine&#xFF1A;</p>
<p><img src="Goroutine&#x662F;&#x600E;&#x4E48;&#x5F00;&#x59CB;&#x548C;&#x9000;&#x51FA;&#x7684;/1*4hxav30Z3T8uwoNyWlfiOQ-20200405145110460.png" alt="img"></p>
<p>&#x6B64;&#x51FD;&#x6570;&#x5C06;&#x9996;&#x5148;&#x8FD0;&#x884C;&#x5EF6;&#x8FDF;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x5728; goroutine &#x9000;&#x51FA;&#x65F6;&#x8C03;&#x7528;&#x5148;&#x524D;&#x770B;&#x5230;&#x7684;&#x76F8;&#x540C;&#x51FD;&#x6570;&#x3002;</p>
<h4 id="&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#xFF1A;">&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#xFF1A;</h4>
<h6 id="demo01-&#x521B;&#x5EFA;&#x4E00;&#x4E2A;-goroutine">Demo01: &#x521B;&#x5EFA;&#x4E00;&#x4E2A; goroutine</h6>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;sync&quot;</span>
    <span class="hljs-string">&quot;fmt&quot;</span>
)
<span class="hljs-keyword">func</span> main()  {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">go</span> <span class="hljs-keyword">func</span>(){
        fmt.Println(<span class="hljs-string">&quot;goroutine is running...&quot;</span>)
        wg.Done()
    }()
    fmt.Println(<span class="hljs-string">&quot;main is running...&quot;</span>)
    wg.Wait()
}
</code></pre>
<h6 id="demo02-&#x6253;&#x5370;-&#x8C03;&#x7528;&#x8005;&#x6570;&#x636E;">Demo02: &#x6253;&#x5370; &#x8C03;&#x7528;&#x8005;&#x6570;&#x636E;</h6>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;fmt&quot;</span>
    <span class="hljs-string">&quot;runtime&quot;</span>
    <span class="hljs-string">&quot;sync&quot;</span>
)

<span class="hljs-keyword">func</span> main() {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">go</span> <span class="hljs-keyword">func</span>() {

        <span class="hljs-keyword">var</span> skip <span class="hljs-keyword">int</span>
        <span class="hljs-keyword">for</span> {
            _, file, line, ok := runtime.Caller(skip)
            <span class="hljs-keyword">if</span> !ok {
                <span class="hljs-keyword">break</span>
            }
            fmt.Printf(<span class="hljs-string">&quot;%s%d\n&quot;</span>, file, line)
            skip++
        }
        wg.Done()
    }()
    wg.Wait()
}

<span class="hljs-comment">/* output:

/Users/zcj/panda/git4me/daily-log-archive/2020-04-05/demo01/main.go16
/usr/local/go/src/runtime/asm_amd64.s1373

*/</span>
</code></pre>
<h6 id="demo03-&#x624B;&#x52A8;&#x8C03;&#x7528;-runtimegoexit-&#x9000;&#x51FA;-goroutine">Demo03: &#x624B;&#x52A8;&#x8C03;&#x7528; runtime.Goexit() &#x9000;&#x51FA; goroutine</h6>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;fmt&quot;</span>
    <span class="hljs-string">&quot;runtime&quot;</span>
    <span class="hljs-string">&quot;sync&quot;</span>
)

<span class="hljs-keyword">func</span> main() {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">go</span> <span class="hljs-keyword">func</span>() {
        <span class="hljs-keyword">defer</span> wg.Done()
        runtime.Goexit() <span class="hljs-comment">// goroutine exits here</span>
        fmt.Println(<span class="hljs-string">&quot;this line code never executed&quot;</span>)
    }()
    wg.Wait()
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../2020-03-18/gitbook工具使用指南.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: gitbook工具使用指南">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Goroutine是怎么开始和退出的","level":"1.4","depth":1,"next":{"title":"2020-04-07","level":"2.1","depth":1,"ref":"","articles":[]},"previous":{"title":"gitbook工具使用指南","level":"1.3","depth":1,"path":"2020-03-18/gitbook工具使用指南.md","ref":"./2020-03-18/gitbook工具使用指南.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"2020-04-05/Goroutine是怎么开始和退出的.md","mtime":"2020-04-15T06:14:50.168Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-15T06:15:30.771Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

